// ==UserScript==
// @name         MHW ASS - Professional Build Card
// @namespace    http://tampermonkey.net/
// @version      2.2
// @description  Turns ASS Output into A image you can Download and share!.
// @match        *://*.wiki-db.com/sim/*
// @grant        none
// @require      https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js
// ==/UserScript==

(function() {
    'use strict';

    // Editable Icon Dictionary
    const ICONS = {
        1: 'https://monsterhunterworld.wiki.fextralife.com/file/Monster-Hunter-World/mhw-decoration-level-1.png',
        2: 'https://monsterhunterworld.wiki.fextralife.com/file/Monster-Hunter-World/mhw-decoration-level-2.png',
        3: 'https://monsterhunterworld.wiki.fextralife.com/file/Monster-Hunter-World/mhw-decoration-level-3.png',
        4: 'https://monsterhunterworld.wiki.fextralife.com/file/Monster-Hunter-World/mhw-decoration-level-4.png',
        'GS': '/static/mhsim/simicons/greatsword.png',
        'LS': '/static/mhsim/simicons/longsword.png',
        'SnS': '/static/mhsim/simicons/longsword.png',
        'DB': '/static/mhsim/simicons/longsword.png',
        'Ham': '/static/mhsim/simicons/longsword.png',
        'HH': '/static/mhsim/simicons/hammer.png',
        'LNC': '/static/mhsim/simicons/longsword.png',
        'GL': '/static/mhsim/simicons/longsword.png',
        'SWA': '/static/mhsim/simicons/longsword.png',
        'CB': '/static/mhsim/simicons/longsword.png',
        'IG': '/static/mhsim/simicons/longsword.png',
        'LBG': '/static/mhsim/simicons/longsword.png',
        'HBG': '/static/mhsim/simicons/longsword.png',
        'Bow': '/static/mhsim/simicons/longsword.png',
        'HELM': '/static/mhsim/simicons/head.png'
    };

    const style = document.createElement('style');
    style.innerHTML = `
        .mhw-card-wrapper {
            display: flex; flex-direction: column; gap: 15px; background-color: #0c0c0c; color: #efefef;
            font-family: 'Segoe UI', sans-serif; padding: 35px; border-radius: 4px;
            border: 1px solid #222; margin: 20px 0; width: 950px;
        }
        .mhw-build-title-display { font-size: 2.2em; font-weight: bold; color: #fff; border-bottom: 2px solid #3498db; margin-bottom: 15px; padding-bottom: 5px; }
        .mhw-main-row { display: flex; gap: 20px; }
        .mhw-column { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .mhw-section-title { font-size: 0.75em; text-transform: uppercase; color: #666; border-bottom: 1px solid #222; margin-bottom: 8px; padding-bottom: 4px; }

        .mhw-item { background: #181818; padding: 10px 14px; border-left: 4px solid #3498db; display: flex; justify-content: space-between; align-items: center; min-height: 40px; }

        /* WEAPON ROW STANDARDIZED */
        .mhw-weapon-row { border-left-color: #e67e22 !important; padding: 0 !important; overflow: hidden; display: flex; flex-direction: row; }
        .mhw-weapon-icon-box { background: #222; padding: 10px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #333; min-width: 60px;}

        /* Weapon Name now matches standard text size and color */
        .mhw-weapon-name-box {
            flex: 1; padding: 0 15px; display: flex; align-items: center;
            font-size: 0.9em; /* Matches .mhw-equip-name */
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .mhw-weapon-slots-box { display: flex; flex-direction: column; border-left: 1px solid #333; flex-shrink: 0; }
        .mhw-slot-entry { display: flex; align-items: center; gap: 10px; padding: 5px 15px; border-bottom: 1px solid #333; min-width: 180px; }
        .mhw-slot-entry:last-child { border-bottom: none; }
        .mhw-slot-text { font-family: monospace; font-size: 1.1em; color: #e67e22; letter-spacing: 2px; }
        .mhw-weapon-innate { color: #888; font-style: italic; font-size: 0.75em; margin-left: auto; white-space: nowrap; }

        .mhw-equip-name, .mhw-deco-name { font-size: 0.9em; display: flex; align-items: center; gap: 10px; }
        .mhw-icon-img { height: 22px; width: 22px; object-fit: contain; }
        .mhw-icon-large { height: 40px; width: 40px; }

        /* DECO GRID RESTORED */
        .mhw-deco-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .mhw-deco-qty { color: #f1c40f; font-weight: bold; margin-left: auto; }

        .mhw-skill-name { font-weight: 600; font-size: 0.95em; }
        .mhw-skill-lv { color: #f1c40f; font-weight: bold; font-size: 0.9em; }
        .mhw-skill-overcap { color: #e74c3c !important; }
        .mhw-special-text { color: #f1c40f; font-style: italic; font-size: 0.9em; }

        .mhw-controls { display: flex; flex-wrap: wrap; gap: 12px; margin: 15px 0; background: #1a1a1a; padding: 15px; border-radius: 5px; border: 1px solid #333; }
        .mhw-input { background: #000; color: white; border: 1px solid #444; padding: 8px 12px; border-radius: 3px; }
        .mhw-select { background: #000; color: white; border: 1px solid #444; padding: 8px; border-radius: 3px; }
        .mhw-action-btn { background: #3498db; color: #fff; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .mhw-dl-btn { background: #27ae60; }
    `;
    document.head.appendChild(style);

    function extractData(containerDiv) {
        const tables = containerDiv.querySelectorAll('table');
        if (tables.length < 2) return null;

        let equipment = [];
        let rawDecos = "";
        tables[0].querySelectorAll('tr').forEach(tr => {
            const firstCell = tr.querySelector('td:first-child');
            if (firstCell && firstCell.innerText.trim().includes("Deco")) {
                rawDecos = tr.querySelector('td:nth-child(2)')?.innerText.trim();
            } else {
                const link = tr.querySelector('td:nth-child(2) a');
                if (link) equipment.push({ name: link.innerText.trim(), img: link.querySelector('img')?.src });
            }
        });

        let innateSkills = [];
        let weaponSlots = "0-0-0";
        let helmSlots = "0-0-0";
        const skillRows = tables[1].querySelectorAll('tr');

        skillRows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            if (cells.length >= 11) {
                if (parseInt(cells[1].innerText) > 0) innateSkills.push(cells[0].innerText.trim());
            }
            if (tr.innerText.includes("Slots")) {
                const cell = tr.querySelector('td:nth-child(2)');
                cell.querySelectorAll('img').forEach(img => {
                    const nextText = img.nextSibling?.textContent?.trim();
                    if (img.src.includes('head.png')) helmSlots = nextText || "0-0-0";
                    else weaponSlots = nextText || "0-0-0";
                });
            }
        });
        innateSkills.sort();

        let skills = [];
        skillRows.forEach((tr, i) => {
            if (i === 0 || tr.innerText.includes("Slots")) return;
            const cells = tr.querySelectorAll('td');
            if (cells.length >= 11 && cells[10].innerText.trim()) {
                const lvM = cells[10].innerText.match(/Lv(\d+)/i);
                skills.push({ name: cells[0].innerText.trim(), full: cells[10].innerText.trim(), level: lvM ? parseInt(lvM[1]) : 0, isOvercap: lvM && (parseInt(cells[9].innerText) > parseInt(lvM[1])) });
            }
        });
        skills.sort((a, b) => (a.level !== b.level) ? b.level - a.level : a.name.localeCompare(b.name));

        return { equipment, skills, decorations: rawDecos, weaponSlots, helmSlots, innateSkills };
    }

    function renderCard(containerDiv, data, buildName, weaponName, weaponType) {
        let card = containerDiv.querySelector('.mhw-card-wrapper') || document.createElement('div');
        card.className = 'mhw-card-wrapper';
        containerDiv.appendChild(card);

        const decos = [];
        const matches = data.decorations.matchAll(/([a-zA-Z\s\d]+?)\s*(?:\[(\d)\])?\*(\d+)/g);
        for (const m of matches) decos.push({ name: m[1].trim(), level: m[2] || m[1].match(/\d$/)?.[0] || "1", qty: m[3] });

        card.innerHTML = `
            ${buildName ? `<div class="mhw-build-title-display">${buildName}</div>` : ''}
            <div class="mhw-main-row">
                <div class="mhw-column">
                    <div class="mhw-section-title">Weapon & Equipment</div>

                    <div class="mhw-item mhw-weapon-row">
                        <div class="mhw-weapon-icon-box">
                            <img src="${ICONS[weaponType]}" class="mhw-icon-large" crossorigin="anonymous">
                        </div>
                        <div class="mhw-weapon-name-box">
                            ${weaponName || 'UNNAMED WEAPON'}
                        </div>
                        <div class="mhw-weapon-slots-box">
                            <div class="mhw-slot-entry">
                                <img src="${ICONS.HELM}" class="mhw-icon-img" crossorigin="anonymous">
                                <span class="mhw-slot-text">${data.helmSlots}</span>
                                <span class="mhw-weapon-innate">${data.innateSkills[0] || ''}</span>
                            </div>
                            <div class="mhw-slot-entry">
                                <img src="${ICONS[weaponType]}" class="mhw-icon-img" crossorigin="anonymous">
                                <span class="mhw-slot-text">${data.weaponSlots}</span>
                                <span class="mhw-weapon-innate">${data.innateSkills[1] || ''}</span>
                            </div>
                        </div>
                    </div>

                    ${data.equipment.map(e => `<div class="mhw-item"><span class="mhw-equip-name"><img src="${e.img}" class="mhw-icon-img" crossorigin="anonymous"> ${e.name}</span></div>`).join('')}

                    <div class="mhw-section-title" style="margin-top:20px;">Decorations</div>
                    <div class="mhw-deco-grid">
                        ${decos.map(d => `<div class="mhw-item"><span class="mhw-deco-name"><img src="${ICONS[d.level] || ''}" class="mhw-icon-img" crossorigin="anonymous">${d.name}</span><span class="mhw-deco-qty">x${d.qty}</span></div>`).join('')}
                    </div>
                </div>
                <div class="mhw-column">
                    <div class="mhw-section-title">Active Skills</div>
                    ${data.skills.map(s => {
                        const isL = s.full.includes('Lv');
                        const disp = isL ? s.full.split(' ').pop() : s.full.match(/\(([^)]+)\)/)?.[0] || s.full;
                        return `<div class="mhw-item"><span class="mhw-skill-name">${s.name}</span><span class="${isL ? 'mhw-skill-lv' : 'mhw-special-text'} ${s.isOvercap ? 'mhw-skill-overcap' : ''}">${disp}</span></div>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function initTransformer(wrap) {
        if (wrap.querySelector('.mhw-controls')) return;
        const controls = document.createElement('div');
        controls.className = 'mhw-controls';

        const bInput = document.createElement('input'); bInput.className = 'mhw-input'; bInput.placeholder = 'Build Name';
        const wInput = document.createElement('input'); wInput.className = 'mhw-input'; wInput.placeholder = 'Weapon Name';

        const wSelect = document.createElement('select'); wSelect.className = 'mhw-select';
        ['GS', 'LS','SnS','DB','Ham', 'HH','LNC','GL','SWA','CB','IG','LBG','HBG','Bow'].forEach(t => { const o = document.createElement('option'); o.value = t; o.innerText = t; wSelect.appendChild(o); });

        const genBtn = document.createElement('button'); genBtn.className = 'mhw-action-btn'; genBtn.innerText = "âœ¨ Generate";
        const dlBtn = document.createElement('button'); dlBtn.className = 'mhw-action-btn mhw-dl-btn'; dlBtn.innerText = "ðŸ’¾ Save PNG";

        controls.append(bInput, wInput, wSelect, genBtn, dlBtn);
        wrap.prepend(controls);

        genBtn.onclick = () => {
            const data = extractData(wrap);
            if (data) renderCard(wrap, data, bInput.value, wInput.value, wSelect.value);
        };
        dlBtn.onclick = () => {
            const card = wrap.querySelector('.mhw-card-wrapper');
            if (card) html2canvas(card, { backgroundColor: "#0c0c0c", scale: 3, useCORS: true }).then(canvas => {
                const link = document.createElement('a'); link.download = `${bInput.value || 'Build'}.png`; link.href = canvas.toDataURL('image/png'); link.click();
            });
        };
    }

    const observer = new MutationObserver((mutations) => {
        mutations.forEach(m => m.addedNodes.forEach(node => {
            if (node.nodeType === 1) node.querySelectorAll('td[colspan="7"] > div').forEach(wrap => initTransformer(wrap));
        }));
    });
    observer.observe(document.body, { childList: true, subtree: true });
})();
